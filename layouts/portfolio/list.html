{{ define "main" }}

<section class="bg-whiteSmoke dark:bg-gray-900">
    <div class="py-8 px-4 mx-auto max-w-screen-xl text-center lg:py-16 lg:px-12">
        <p class="uppercase text-gunmetal font-semibold mb-4 text-sm tracking-widest">Tom Smith Design</p>
        <h1 class="mb-4 text-4xl text-gunmetal font-extrabold tracking-tight leading-none md:text-5xl lg:text-6xl dark:text-white">Portfolio</h1>
        <p class="text-gunmetal mb-4 sm:mb-0 text-lg font-normal lg:text-xl sm:px-16 xl:px-48 dark:text-gray-400">This is a small selection of my favorite projects and works, ranging from product design to print design. Like what you see? <a href="/contact/" class="text-primary-500">Get in touch</a>.</p>
    </div>
</section>

<section class="bg-whiteSmoke dark:bg-gray-900 antialiased">
    <div class="px-4 mx-auto lg:px-6 pb-8 md:pb-16">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {{ range $index, $page := .Pages.ByWeight }}
                {{ $cover := "" }}
                {{ $galleryImages := slice }}
                {{ with $page.Params.gallery }}
                    {{ with index . 0 }}
                        {{ $cover = .src }}
                    {{ end }}
                    {{ range . }}
                        {{ if .src }}
                            {{ $galleryImages = $galleryImages | append .src }}
                        {{ end }}
                    {{ end }}
                {{ end }}
                {{ if not $cover }}
                    {{ with .Params.ogimage }}
                        {{ $cover = . }}
                    {{ end }}
                {{ end }}
                {{ if not $cover }}
                    {{ $cover = "/images/portfolio/thumbnails/alaeris-thumbnail.jpg" }}
                {{ end }}
                {{ if not (gt (len $galleryImages) 0) }}
                    {{ $galleryImages = slice $cover }}
                {{ end }}
                {{ $galleryList := delimit $galleryImages "||" }}
                <div>
                    <a href="{{ $page.RelPermalink }}" class="group block focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 focus-visible:ring-offset-whiteSmoke dark:focus-visible:ring-offset-gray-900">
                        <div class="portfolio-card w-full rounded-lg relative border border-gunmetal aspect-[827/640] overflow-hidden bg-gunmetal touch-pan-y" data-gallery-images="{{ $galleryList }}">
                            <div class="absolute inset-0 overflow-hidden portfolio-card-bg">
                                <div class="portfolio-card-slide portfolio-card-slide-active absolute inset-0 bg-cover bg-center transition-transform duration-500 ease-in-out translate-x-0" style="background-image:url('{{ $cover }}');"></div>
                            </div>
                            <div class="absolute bottom-3 left-1/2 -translate-x-1/2 inline-flex items-center gap-2 bg-black/70 text-white text-xs font-semibold tracking-wide uppercase py-1 px-3 rounded-full shadow md:hidden pointer-events-none">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M8 5l-4 4 4 4M16 9l4 4-4 4" />
                                </svg>
                                <span>Swipe</span>
                            </div>
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 group-focus-visible:opacity-100 transition-opacity duration-500 flex items-center justify-center pointer-events-none">
                                <p class="text-white text-lg font-semibold">{{ $page.Title }}</p>
                            </div>
                        </div>
                    </a>
                </div>
            {{ end }}
        </div>
    </div>
</section>

<span class="hidden translate-x-full -translate-x-full"></span>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.portfolio-card');
        const hoverDelay = 400;
        const swipeThreshold = 20;
        const isTouchDevice = window.matchMedia('(hover: none)').matches
            || window.matchMedia('(pointer: coarse)').matches
            || navigator.maxTouchPoints > 0
            || ('ontouchstart' in window);

        const createSlide = (url) => {
            const slide = document.createElement('div');
            slide.className = 'portfolio-card-slide absolute inset-0 bg-cover bg-center transition-transform duration-500 ease-in-out';
            slide.style.backgroundImage = `url('${url}')`;
            return slide;
        };

        cards.forEach((card) => {
            const bgContainer = card.querySelector('.portfolio-card-bg');
            if (!bgContainer) return;
            const data = card.dataset.galleryImages || '';
            const images = data.split('||').map((item) => item.trim()).filter(Boolean);
            if (!images.length) return;

            const parentLink = card.closest('a');
            card.dataset.blockClick = 'false';

            let index = 0;
            let intervalId = null;
            let isHovering = false;
            let isAnimating = false;
            let activeSlide = bgContainer.querySelector('.portfolio-card-slide-active');
            let animationSession = 0;

            const renderSlideAt = (targetIndex) => {
                const slides = bgContainer.querySelectorAll('.portfolio-card-slide');
                slides.forEach((slide) => slide.remove());
                activeSlide = createSlide(images[targetIndex]);
                activeSlide.classList.add('translate-x-0', 'portfolio-card-slide-active');
                bgContainer.appendChild(activeSlide);
                index = targetIndex;
                isAnimating = false;
            };

            if (!activeSlide) {
                renderSlideAt(0);
            } else {
                activeSlide.classList.add('portfolio-card-slide-active');
                activeSlide.classList.remove('-translate-x-full', 'translate-x-full');
                activeSlide.classList.add('translate-x-0');
            }

            if (images.length < 2) return;

            const animateTo = (nextIndex, direction = 'forward') => {
                if (isAnimating || nextIndex === index) return false;
                isAnimating = true;
                const session = animationSession;

                const incoming = createSlide(images[nextIndex]);
                const entryClass = direction === 'backward' ? '-translate-x-full' : 'translate-x-full';
                const exitClass = direction === 'backward' ? 'translate-x-full' : '-translate-x-full';
                incoming.classList.add(entryClass);
                bgContainer.appendChild(incoming);

                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        if (session !== animationSession) {
                            incoming.remove();
                            isAnimating = false;
                            return;
                        }
                        incoming.classList.remove(entryClass);
                        incoming.classList.add('translate-x-0', 'portfolio-card-slide-active');

                        if (activeSlide) {
                            const slideToRemove = activeSlide;
                            let cleaned = false;
                            const cleanup = () => {
                                if (cleaned) return;
                                cleaned = true;
                                slideToRemove.removeEventListener('transitionend', cleanup);
                                if (slideToRemove.parentElement) {
                                    slideToRemove.remove();
                                }
                                isAnimating = false;
                            };
                            slideToRemove.classList.remove('translate-x-0', '-translate-x-full', 'translate-x-full', 'portfolio-card-slide-active');
                            slideToRemove.classList.add(exitClass);
                            slideToRemove.addEventListener('transitionend', cleanup);
                            setTimeout(cleanup, 900);
                        } else {
                            isAnimating = false;
                        }

                        activeSlide = incoming;
                        index = nextIndex;
                    });
                });

                return true;
            };

            const runSlide = () => {
                animateTo((index + 1) % images.length, 'forward');
            };

            const stopCycle = () => {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                isHovering = false;
                animationSession++;
                renderSlideAt(0);
            };

            const startCycle = () => {
                if (isHovering) return;
                isHovering = true;
                runSlide();
                intervalId = setInterval(runSlide, hoverDelay);
            };

            if (!isTouchDevice) {
                card.addEventListener('pointerenter', startCycle);
                card.addEventListener('pointerleave', stopCycle);
                card.addEventListener('focusin', startCycle);
                card.addEventListener('focusout', stopCycle);
            } else if (parentLink) {
                parentLink.addEventListener('click', (evt) => {
                    if (card.dataset.blockClick === 'true') {
                        evt.preventDefault();
                        card.dataset.blockClick = 'false';
                    }
                });
            }

            if (isTouchDevice) {
                let touchStartX = 0;
                let touchStartY = 0;
                let swipeHandled = false;

                const resetBlockedClick = () => {
                    setTimeout(() => {
                        card.dataset.blockClick = 'false';
                    }, 120);
                };

                card.addEventListener('touchstart', (event) => {
                    if (event.touches.length !== 1) return;
                    touchStartX = event.touches[0].clientX;
                    touchStartY = event.touches[0].clientY;
                    swipeHandled = false;
                }, { passive: true });

                card.addEventListener('touchmove', (event) => {
                    if (event.touches.length !== 1 || swipeHandled) return;
                    const dx = event.touches[0].clientX - touchStartX;
                    const dy = event.touches[0].clientY - touchStartY;
                    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > swipeThreshold) {
                        const direction = dx < 0 ? 'forward' : 'backward';
                        const targetIndex = direction === 'forward'
                            ? (index + 1) % images.length
                            : (index - 1 + images.length) % images.length;
                        const started = animateTo(targetIndex, direction);
                        if (started) {
                            swipeHandled = true;
                            card.dataset.blockClick = 'true';
                            event.preventDefault();
                        }
                    }
                }, { passive: false });

                const handleTouchEnd = () => {
                    resetBlockedClick();
                };

                card.addEventListener('touchend', handleTouchEnd);
                card.addEventListener('touchcancel', handleTouchEnd);
            } else if (parentLink) {
                parentLink.addEventListener('click', () => {
                    card.dataset.blockClick = 'false';
                });
            }
        });
    });
</script>

{{ end }}
